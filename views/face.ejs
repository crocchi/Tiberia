<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Bust Animation with Three.js</title>
    <style>
        html,
        body,
        canvas {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        button {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 32px;
            font-size: 1.2em;
            background: #ffeb3b;
            color: #222;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(45, 44, 44, 0.2);
            cursor: pointer;
            z-index: 20;
            transition: background 0.2s;
        }
    </style>
</head>

<body>
    <button id="playBtn">
        ‚ñ∂Ô∏è Fai parlare Spongebob!
    </button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        // Initialize scene, camera, renderer
        let bones = {};   // qui salveremo tutte le bones
        let meshes = {}; // qui salveremo tutte le mesh
        let audioCtx = null;
        let source = null;

        let occhioDx = "Right_Top_Eyelid_017";
        let occhioSx = "Left_Top_Eyelid_014";
        let labbro = "Jaw_06";// rotation.x apre la bocca
        let bustoBone = "ÔøΩÔøΩÔøΩ_05"//muovi osso busto
        let naso = "Nose_09"//muovi osso naso
        let pupillaDx = "ÔøΩÔøΩÔøΩR_016"//muovi osso pupilla destra
        let pupillaSx = "ÔøΩÔøΩÔøΩL_013"//muovi osso pupilla sinistra

        const init = async () => {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(
                35,
                window.innerWidth / window.innerHeight,
                0.1,
                100
            );
            camera.position.set(0, 0, 2);// posizione camera
            camera.lookAt(0, 0, 0);       // guarda il centro della scena
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            // Aggiungi una luce direzionale per ombreggiatura
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(4, 4, 5);
            scene.add(directionalLight);

            // Load GLB model
            const loader = new THREE.GLTFLoader();
            let model;
            loader.load('https://tiberia.onrender.com/models/spongebob.glb', function (gltf) {
                model = gltf.scene;
                scene.add(model);

                // Position and scale for bust view
                model.position.set(0, 0, 0);
                model.scale.set(0.2, 0.2, 0.2);
                console.log(model)

                // trova tutte le bones
                model.traverse((obj) => {
                    if (obj.isBone) {
                        bones[obj.name] = obj;
                        // console.log("Trovato bone:", obj.name);

                        // obj.scale.set(2, 2, 1);
                    }
                    if (obj.type === "Bone") {

                    } else if (obj.type === "SkinnedMesh") {
                        meshes[obj.name] = obj;
                        //  console.log("Trovata mesh:", obj.name);
                    } else if (obj.morphTargetInfluences) {
                        console.log("Trovato morph target:", obj.name);
                        // Imposta l'influenza del morph target (ad esempio, 0.5 per met√† trasformazione)
                        obj.morphTargetInfluences[0] = 1.0; // Cambia l'indice e il valore secondo le tue esigenze
                    }

                });


                /*
                bones["Head"].rotation.x = THREE.MathUtils.degToRad(10);
            bones["Head"].rotation.y = THREE.MathUtils.degToRad(-5);
            ‚úî Posizione (meno comune)
     
            bones["Jaw"].position.y -= 0.01;
    
            bones["Neck"].scale.y = 1.2;*/
                console.log("Bones trovate:", bones);
                console.log("Meshes trovate:", meshes);
                //fucker();
            }, undefined, function (error) {
                console.error(error);
            });

            console.log(scene)

            // Controls for interaction
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enablePan = true;
            controls.enableZoom = true;
            controls.enableRotate = true;

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // Handle window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });


        }


        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        const fucker = async () => {
            // ...dopo aver trovato tutte le bones...
            console.log("Inizio modifiche motherfucka bones tra 2 secondi...");
            await sleep(2000);
            // ora modifica le bones
            // Cicla su ogni bone, applica rotazione, aspetta 1 sec, ripristina
            for (const boneName in bones) {
                const bone = bones[boneName];
                const oldX = bone.rotation.x;
                const oldY = bone.rotation.y;

                console.log("Test bone:", boneName);
                bone.rotation.x += 0.5; // ruota un po' la bone
                await sleep(1000);   // aspetta 1 secondo
                bone.rotation.x = oldX; // ripristina
                bone.rotation.y += 0.5;
                await sleep(1000);
                bone.rotation.y = oldY;
            }
        };



        function blinkEyes() {
            // Genera un numero casuale tra 0 e 1
            const random = Math.random();
            if (random < 0.2) { // 20% di probabilit√† di chiudere gli occhi completamente
                if (bones["Right_Top_Eyelid_017"] && bones["Left_Top_Eyelid_014"]) {
                    bones["Right_Top_Eyelid_017"].rotation.x += 1.45;
                    bones["Left_Top_Eyelid_014"].rotation.x += 1.45;
                    setTimeout(() => {
                        bones["Right_Top_Eyelid_017"].rotation.x -= 1.45;
                        bones["Left_Top_Eyelid_014"].rotation.x -= 1.45;
                    }, 200); // occhi chiusi per 200ms
                }
            } else { // blink normale
                if (bones["Right_Top_Eyelid_017"] && bones["Left_Top_Eyelid_014"]) {
                    bones["Right_Top_Eyelid_017"].rotation.x += 0.6;
                    bones["Left_Top_Eyelid_014"].rotation.x += 0.6;
                    setTimeout(() => {
                        bones["Right_Top_Eyelid_017"].rotation.x -= 0.6;
                        bones["Left_Top_Eyelid_014"].rotation.x -= 0.6;
                    }, 200); // occhi chiusi per 200ms
                }
            }
        }

        setInterval(blinkEyes, 2700);
        //sorriso=est bone: Jaw_06
        /*
          Test bone: Upper_Lip_08
  (index):142 Test bone: Upper_Lip_end_080
  (index):142 Test bone: Nose_09
  (index):142 Test bone: Nose_end_094
  Test bone: Right_Top_Eyelid_017
  pupilla ÔøΩÔøΩÔøΩR_016
          ÔøΩÔøΩÔøΩL_013
  
  */
        document.addEventListener('DOMContentLoaded', (event) => {


            init();
            const playBtn = document.getElementById('playBtn');
            playBtn.addEventListener('click', () => {
                playBtn.disabled = true;
                playBtn.textContent = "üé§ Spongebob sta parlando...";
                socket.emit('requestAudio', 'Ciao io sono Spongebob, e tu? COme stai in questa bellissima giornata? Spero tutto bene!');
            });

            playBtn.addEventListener('mouseover', () => {

                if (bones[pupillaDx]) {
                    bones[pupillaDx].rotation.x = THREE.MathUtils.degToRad(30);
                    bones[occhioDx].rotation.x = THREE.MathUtils.degToRad(15);
                    bones[bustoBone].rotation.x = THREE.MathUtils.degToRad(30);
                }
                if (bones[pupillaSx]) {
                    bones[pupillaSx].rotation.x = THREE.MathUtils.degToRad(30);
                    bones[occhioSx].rotation.x = THREE.MathUtils.degToRad(15);
                    bones[bustoBone].rotation.x = THREE.MathUtils.degToRad(30);
                }
            });
            playBtn.addEventListener('mouseout', () => {

                if (bones[pupillaDx]) {
                    bones[pupillaDx].rotation.x = THREE.MathUtils.degToRad(0);
                    bones[occhioDx].rotation.x = THREE.MathUtils.degToRad(0);
                    bones[bustoBone].rotation.x = THREE.MathUtils.degToRad(0);
                }
                if (bones[pupillaSx]) {
                    bones[pupillaSx].rotation.x = THREE.MathUtils.degToRad(0);
                    bones[occhioSx].rotation.x = THREE.MathUtils.degToRad(0);
                    bones[bustoBone].rotation.x = THREE.MathUtils.degToRad(0);
                }
            });

            let mouthActive = false;
            socket.on('audioData', ({ audioBase64, visemeSequence }) => {
                // Decodifica il base64 in ArrayBuffer
                const binary = atob(audioBase64);
                const len = binary.length;
                const buffer = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    buffer[i] = binary.charCodeAt(i);
                }
                console.log("Viseme Sequence ricevuta:", visemeSequence);
                // Usa AudioContext per riprodurre l'audio
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.decodeAudioData(buffer.buffer, (audioBuffer) => {
                    const source = audioCtx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioCtx.destination);
                    source.start();

                    //analizza audio per movimento bocca
                    const analyser = audioCtx.createAnalyser();
                    source.connect(analyser);
                    analyser.connect(audioCtx.destination);
                    let dataArray = new Uint8Array(analyser.frequencyBinCount);

                    // Avvia animazione visemi sincronizzata
                    let mouthActive = false;
                    function animateMouth() {
                        if (!mouthActive) return; // esci dal ciclo se la bocca non deve pi√π muoversi
                        console.log("Animazione bocca in corso...");
                        analyser.getByteFrequencyData(dataArray);
                        let avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                        bones["Jaw_06"].rotation.x = avg / 64; // valore tra 0 e ~2
                        requestAnimationFrame(animateMouth);
                    }
                    mouthActive = true;
                    animateMouth();

                    // Gestione fine audio
                    source.onended = () => {
                        mouthActive = false;
                        if (bones["Jaw_06"]) bones["Jaw_06"].rotation.x = 0.5; // posizione di riposo
                        playBtn.disabled = false;
                        playBtn.textContent = "‚ñ∂Ô∏è Fai parlare Spongebob!";
                    };
                });

            });


        });
    </script>
</body>

</html>